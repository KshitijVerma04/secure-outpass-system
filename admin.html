<script type="module">
import { auth, db } from "./firebase.js";
import { 
  collection, query, where, getDocs, doc, updateDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

auth.onAuthStateChanged(async (user) => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // ðŸ” ROLE CHECK
  const userDoc = await getDoc(doc(db, "users", user.uid));

  if (!userDoc.exists() || userDoc.data().role !== "admin") {
    window.location.href = "login.html";
    return;
  }

  // âœ… LOGOUT
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  // âœ… FETCH PENDING ADMIN APPROVALS
  const q = query(
    collection(db, "outpasses"),
    where("status", "==", "pending_admin")
  );

  const querySnapshot = await getDocs(q);
  const container = document.getElementById("adminOutpasses");

  if (querySnapshot.empty) {
    container.innerHTML = "<p>No pending approvals.</p>";
    return;
  }

  // âœ… USE for...of INSTEAD OF forEach
  for (const docSnap of querySnapshot.docs) {

    const data = docSnap.data();

    // Fetch student details
    const studentDoc = await getDoc(doc(db, "users", data.studentId));
    const studentData = studentDoc.data();

    const div = document.createElement("div");

    div.innerHTML = `
      <hr>
      <h3>Student Details</h3>
      <p><b>Name:</b> ${studentData?.name || "N/A"}</p>
      <p><b>Reg No:</b> ${studentData?.regNo || "N/A"}</p>
      <p><b>Block:</b> ${studentData?.block || "N/A"}</p>
      <p><b>Room No:</b> ${studentData?.roomNo || "N/A"}</p>

      <h3>Outpass Request</h3>
      <p><b>Destination:</b> ${data.destination}</p>
      <p><b>Reason:</b> ${data.reason}</p>
      <p><b>From:</b> ${data.fromDate}</p>
      <p><b>To:</b> ${data.toDate}</p>

      <button class="approveBtn">Final Approve</button>
      <button class="rejectBtn">Reject</button>
    `;

    // âœ… APPROVE
    div.querySelector(".approveBtn").addEventListener("click", async () => {

      const expiryDate = new Date();
      expiryDate.setHours(expiryDate.getHours() + 24);

      await updateDoc(doc(db, "outpasses", docSnap.id), {
        status: "approved",
        qrToken: docSnap.id,
        expiry: expiryDate,
        used: false
      });

      alert("Outpass Approved!");
      location.reload();
    });

    // âŒ REJECT
    div.querySelector(".rejectBtn").addEventListener("click", async () => {

      await updateDoc(doc(db, "outpasses", docSnap.id), {
        status: "rejected_by_admin"
      });

      alert("Outpass Rejected.");
      location.reload();
    });

    container.appendChild(div);
  }

});
</script>
