<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<header>
  <h1>Admin Dashboard</h1>
  <button id="logoutBtn" class="logout-btn">Logout</button>
</header>

<div class="dashboard-container">

  <div class="card">
    <h2>Pending Student Registrations</h2>
    <div id="pendingStudents"></div>
  </div>

  <div class="card">
    <h2>Pending Admin Approvals</h2>
    <div id="adminOutpasses"></div>
  </div>

</div>

<script type="module">

import { auth, db } from "./firebase.js";

import {
  collection,
  query,
  where,
  getDocs,
  doc,
  updateDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";


auth.onAuthStateChanged(async (user) => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // ✅ ADMIN ROLE CHECK
  const adminDoc = await getDoc(doc(db, "users", user.uid));

  if (!adminDoc.exists() || adminDoc.data().role !== "admin") {
    window.location.href = "login.html";
    return;
  }

  // ✅ LOGOUT
  document.getElementById("logoutBtn")
    .addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

  // ==================================================
  // ✅ STUDENT APPROVAL SYSTEM (FIXED)
  // ==================================================

  const pendingContainer =
    document.getElementById("pendingStudents");

  const pendingQuery = query(
    collection(db, "users"),
    where("role", "==", "pending_student")
  );

  const pendingSnapshot = await getDocs(pendingQuery);

  if (pendingSnapshot.empty) {
    pendingContainer.innerHTML = "<p>No pending students.</p>";
  } else {

    for (const studentDoc of pendingSnapshot.docs) {

      const student = studentDoc.data();
      const studentId = studentDoc.id;

      const div = document.createElement("div");

      div.innerHTML = `
        <hr>
        <p><b>Name:</b> ${student.name}</p>
        <p><b>Reg No:</b> ${student.regNo}</p>
        <p><b>Block:</b> ${student.block}</p>
        <p><b>Room:</b> ${student.roomNo}</p>
        <p><b>Parent Email:</b> ${student.parentEmail}</p>

        <button class="approveStudentBtn">Approve</button>
        <button class="rejectStudentBtn">Reject</button>
      `;

      // ✅ APPROVE STUDENT
      div.querySelector(".approveStudentBtn")
        .addEventListener("click", async () => {

          await updateDoc(doc(db, "users", studentId), {
            role: "student",
            approved: true,
            status: "approved"
          });

          alert("Student Approved ✅");
          location.reload();
        });

      // ❌ REJECT STUDENT
      div.querySelector(".rejectStudentBtn")
        .addEventListener("click", async () => {

          await updateDoc(doc(db, "users", studentId), {
            status: "rejected"
          });

          alert("Student Rejected ❌");
          location.reload();
        });

      pendingContainer.appendChild(div);
    }
  }


  // ==================================================
  // ✅ OUTPASS APPROVAL SYSTEM
  // ==================================================

  const q = query(
    collection(db, "outpasses"),
    where("status", "==", "pending_admin")
  );

  const snapshot = await getDocs(q);
  const container =
    document.getElementById("adminOutpasses");

  if (snapshot.empty) {
    container.innerHTML = "<p>No pending approvals.</p>";
    return;
  }

  for (const docSnap of snapshot.docs) {

    const data = docSnap.data();

    const studentDoc =
      await getDoc(doc(db, "users", data.studentId));

    const student = studentDoc.data();

    const div = document.createElement("div");

    div.innerHTML = `
      <hr>
      <h3>Student Details</h3>
      <p><b>Name:</b> ${student?.name || "N/A"}</p>
      <p><b>Reg No:</b> ${student?.regNo || "N/A"}</p>
      <p><b>Block:</b> ${student?.block || "N/A"}</p>
      <p><b>Room:</b> ${student?.roomNo || "N/A"}</p>

      <h3>Outpass Request</h3>
      <p><b>Destination:</b> ${data.destination}</p>
      <p><b>Reason:</b> ${data.reason}</p>
      <p><b>From:</b> ${data.fromDate}</p>
      <p><b>To:</b> ${data.toDate}</p>

      <button class="approveBtn">Final Approve</button>
      <button class="rejectBtn">Reject</button>
    `;

    div.querySelector(".approveBtn")
      .addEventListener("click", async () => {

        const expiryDate = new Date();
        expiryDate.setHours(expiryDate.getHours() + 24);

        await updateDoc(doc(db, "outpasses", docSnap.id), {
          status: "approved",
          qrToken: docSnap.id,
          expiry: expiryDate,
          used: false
        });

        alert("Outpass Approved ✅");
        location.reload();
      });

    div.querySelector(".rejectBtn")
      .addEventListener("click", async () => {

        await updateDoc(doc(db, "outpasses", docSnap.id), {
          status: "rejected_by_admin"
        });

        alert("Outpass Rejected ❌");
        location.reload();
      });

    container.appendChild(div);
  }

});
</script>

</body>
</html>
